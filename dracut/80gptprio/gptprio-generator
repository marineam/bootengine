#!/bin/bash
# -*- mode: shell-script; indent-tabs-mode: nil; sh-basic-offset: 4; -*-
# ex: ts=8 sw=4 sts=4 et filetype=sh

set -e

UNIT_DIR="${1:-/tmp}"

# env var for testing
if [[ -n "${GPTPRIO_GENERATOR_CMDLINE}" ]]; then
    cmdline=( ${GPTPRIO_GENERATOR_CMDLINE} )
else
    cmdline=( $(</proc/cmdline) )
fi

# Usage: cmdline_arg name default_value
cmdline_arg() {
    local name="$1" value="$2"
    for arg in "${cmdline[@]}"; do
        if [[ "${arg%%=*}" == "${name}" ]]; then
            value="${arg#*=}"
        fi
    done
    echo "${value}"
}

dev_to_unit() {
    local name="$1"
    name="${name##/}"
    name="${name//-/\\x2d}"
    name="${name//\//-}"
    echo "${name}.device"
}

require_dev() {
    local name=$(dev_to_unit "$1")
    local requires_dir="${UNIT_DIR}/dracut-pre-mount.service.requires"
    local device_dir="${UNIT_DIR}/${name}.d"
    mkdir -p "${requires_dir}" "${device_dir}"
    cat >"${device_dir}/gptprio.conf" <<EOF
# Automatically generated by gptprio-generator
[Unit]
Before=dracut-pre-mount.service
EOF
    ln -sf "../${name}" "${requires_dir}/${name}"
}

usr=$(cmdline_arg usr)

if [[ "${usr%%:*}" == "gptprio" ]]; then
    require_dev "/dev/disk/by-partuuid/7130c94a-213a-4e5a-8e26-6cce9662f132"
    require_dev "/dev/disk/by-partuuid/e03dd35c-7c2d-4a47-b3fe-27f15780a57c"
fi
